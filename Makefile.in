# Copyright © 2012-2017 Jakub Wilk
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the
# “Software”), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
#
# The above copyright notice and this permission notice shall be included
# in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS
# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
# CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
# TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

CC = @CC@
CFLAGS = @CFLAGS@ @NCURSESW_CFLAGS@ @ZLIB_CFLAGS@
CPPFLAGS = @CPPFLAGS@ -DDICTDIR='"$(dictdir)"'
LDFLAGS = @LDFLAGS@
LDLIBS = @NCURSESW_LIBS@ @ZLIB_LIBS@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
datadir = @datadir@
datarootdir = @datarootdir@
mandir = @mandir@
dictdir = @dictdir@

version = @PACKAGE_VERSION@

cfiles := $(wildcard *.c)
ofiles := $(cfiles:.c=.o)

# code
# ====

executables = pwnsjp pwnsjpi

.PHONY: all
all: $(executables)

pwnsjpi: pwnsjp
	ln -sf pwnsjp pwnsjpi

pwnsjp: $(ofiles)
	$(LINK.c) $(^) $(LOADLIBES) $(LDLIBS) -o $(@)

.PHONY: install
install: $(executables)
	echo $(executables) \
	| xargs -n 1 \
	| xargs -t -I {} install -D -m 755 {} $(DESTDIR)$(bindir)/{}

$(ofiles): %.o: %.c

include Makefile.dep
include Makefile.hdr

# documentation
# =============

XSLTPROC = @XSLTPROC@

ifneq "$(XSLTPROC)" ""

xml_files = $(wildcard doc/*.xml)
man_files = $(xml_files:.xml=.1)
all: $(man_files)

docbook_xsl = http://docbook.sourceforge.net/release/xsl/current/manpages/docbook.xsl
xsltproc_options = --param man.authors.section.enabled 0

%.1: %.xml
	sed -e 's,&version;,$(version),g' -e 's,&slowin;,$(dictdir)/slo.win,g' $(<) | \
	$(XSLTPROC) $(xsltproc_options) --output $(@) $(docbook_xsl) -

install: install-doc

.PHONY: install-doc
install-doc:
	echo $(notdir $(man_files)) \
	| xargs -n 1 \
	| xargs -t -I {} install -D doc/{} $(DESTDIR)$(mandir)/man1/{}

endif

# cleaning
# ========

.PHONY: clean
clean:
	rm -f pwnsjp pwnsjpi *.o doc/*.[0-9]

.PHONY: distclean
distclean: clean
	rm -f Makefile config.log config.status setup.h

# vim:ts=4 sts=4 sw=4 noet
